<%- include("partials/header", { title: "Order Detail", subtitle: "Review & take action", active: "orders" }) %>

<%
  const pay = order.payment_status || "UNPAID";
  const os = order.order_status || "QUEUE";
  const fs = order.fulfillment_status || "CONFIRMED";
%>

<div class="grid">

  <div class="card">
    <h2>Customer</h2>
    <div class="chips">
      <span class="chip ok"><%= order.customer_name || "Customer" %></span>
      <span class="chip"><%= order.phone %></span>
    </div>

    <div style="margin-top:10px; color:var(--muted); font-size:13px;">
      Address: <b style="color:var(--txt)"><%= order.address_snapshot %></b>
    </div>
  </div>

  <div class="card">
    <h2>Order Summary</h2>

    <div class="chips">
      <span class="chip <%= pay==='PAID' ? 'ok' : 'warn' %>">Payment: <%= pay %></span>
      <span class="chip ok">Bucket: <%= os %></span>
      <span class="chip">Status: <%= fs %></span>
    </div>

    <div style="margin-top:12px; display:grid; gap:8px;">
      <div>Qty: <b><%= order.qty %> <%= order.unit_label %></b></div>
      <div>Price/unit: <b>₹<%= order.price_per_unit %></b></div>
      <div>Subtotal: <b>₹<%= order.subtotal %></b></div>
      <div>Delivery: <b>₹<%= order.delivery_charge %></b></div>
      <div style="font-size:18px;">Total: <b>₹<%= order.total %></b></div>
    </div>
  </div>

  <% if (os === "QUEUE") { %>
    <div class="card">
      <h2>Actions (Queue)</h2>

      <form method="POST" action="/admin/orders/<%= order.id %>/approve">
        <button class="btn" type="submit">✅ Approve → Move to Active Orders</button>
      </form>

      <div style="height:10px"></div>

      <form method="POST" action="/admin/orders/<%= order.id %>/reject">
        <button class="btn danger" type="submit">❌ Reject</button>
      </form>
    </div>
  <% } %>

  <% if (os === "ACTIVE") { %>
    <div class="card">
      <h2>Actions (Active Orders)</h2>

      <form method="POST" action="/admin/orders/<%= order.id %>/dispatch">
        <button class="btn secondary" type="submit">🚚 Mark Dispatched</button>
      </form>

      <div style="height:10px"></div>

      <form method="POST" action="/admin/orders/<%= order.id %>/mark-delivered">
        <button class="btn warn" type="submit">📦 Mark Delivered</button>
      </form>

      <div style="height:10px"></div>

      <form method="POST" action="/admin/orders/<%= order.id %>/close">
        <button class="btn" type="submit">🔒 Close Order</button>
      </form>
    </div>

    <div class="card">
      <h2>Payment</h2>

      <form method="POST" action="/admin/orders/<%= order.id %>/payment">
        <div class="row row-2">
          <div>
            <label>Status</label>
            <select name="payment_status">
              <option value="UNPAID" <%= pay==='UNPAID'?'selected':'' %>>UNPAID</option>
              <option value="PAID" <%= pay==='PAID'?'selected':'' %>>PAID</option>
            </select>
          </div>
          <div>
            <label>Method</label>
            <select name="payment_method">
              <option value="UPI">UPI</option>
              <option value="CASH">CASH</option>
              <option value="OTHER">OTHER</option>
            </select>
          </div>
        </div>

        <label style="margin-top:10px;">Note</label>
        <textarea name="payment_note" rows="2"><%= order.payment_note || "" %></textarea>

        <div style="height:10px"></div>
        <button class="btn secondary" type="submit">💾 Save Payment</button>
      </form>
    </div>
  <% } %>

</div>

<%- include("partials/footer", { active: "orders" }) %>
