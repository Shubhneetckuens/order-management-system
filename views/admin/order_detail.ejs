<%- include("partials/header", { title: "Order Detail", subtitle: "Items • Total • Actions", active: "orders" }) %>

<%
  const pay = order.payment_status || "UNPAID";
  const os = order.order_status || "QUEUE";
  const fs = order.fulfillment_status || "CONFIRMED";
%>

<% if (q && q.toast) { %>
  <div class="card" style="border-color: rgba(94,234,212,.35); background: rgba(94,234,212,.10);">
    ✅ <%= q.toast %>
  </div>
<% } %>

<div class="grid">

  <div class="card">
    <h2>Customer</h2>
    <div class="chips">
      <span class="chip ok"><%= order.customer_name || "Customer" %></span>
      <span class="chip"><%= order.phone %></span>
      <span class="chip <%= pay==='PAID' ? 'ok' : 'warn' %>">Payment: <%= pay %></span>
    </div>

    <div style="margin-top:10px; color:var(--muted); font-size:13px;">
      Bucket: <b style="color:var(--txt)"><%= os %></b>
      <% if (os === "ACTIVE") { %> • Status: <b style="color:var(--txt)"><%= fs %></b> <% } %>
    </div>
  </div>

  <div class="card">
    <h2>Order Items</h2>

    <% if (!items || items.length === 0) { %>
      <div class="chip">No items added yet</div>
    <% } %>

    <div style="display:grid; gap:10px; margin-top:10px;">
      <% (items || []).forEach(it => { %>
        <div class="order" style="cursor:default; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
            <div>
              <strong><%= it.sub_name %></strong>
              <small style="display:block; color:var(--muted);">
                Qty: <b style="color:var(--txt)"><%= it.qty %></b> <%= it.unit_label %> • ₹<%= it.price_per_unit %> / <%= it.unit_label %>
              </small>
            </div>
            <div style="text-align:right;">
              <div class="money">₹<%= it.subtotal %></div>
              <form method="POST" action="/admin/orders/<%= order.id %>/items/<%= it.id %>/delete" style="margin-top:8px;">
                <button class="btn danger" type="submit">Remove</button>
              </form>
            </div>
          </div>
        </div>
      <% }) %>
    </div>

    <div style="height:10px"></div>

    <h3 style="margin:0 0 8px;">➕ Add Item</h3>
    <form method="POST" action="/admin/orders/<%= order.id %>/items/add">
      <label>Select Sub-Product</label>
      <select name="sub_product_id">
        <% (subProducts || []).forEach(sp => { %>
          <option value="<%= sp.id %>"><%= sp.product_name %> • <%= sp.name %> (₹<%= sp.price_per_unit %>/<%= sp.unit_label %>)</option>
        <% }) %>
      </select>

      <div class="row row-2" style="margin-top:10px;">
        <div>
          <label>Qty</label>
          <input name="qty" placeholder="e.g. 2" />
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="btn secondary" type="submit" style="width:100%;">Add</button>
        </div>
      </div>
    </form>
  </div>

  <div class="card">
    <h2>Total Summary</h2>
    <div style="display:grid; gap:8px;">
      <div>Items Subtotal: <b>₹<%= order.items_subtotal || 0 %></b></div>
      <div>Delivery: <b>₹<%= order.delivery_charge || 0 %></b></div>
      <div style="font-size:18px;">Total: <b>₹<%= order.items_total || order.total || 0 %></b></div>
    </div>

    <div style="margin-top:10px; color:var(--muted); font-size:13px;">
      Address: <b style="color:var(--txt)"><%= order.address_snapshot %></b>
    </div>
  </div>

  <% if (os === "QUEUE") { %>
    <div class="card">
      <h2>Actions (Queue)</h2>
      <div class="chip">Approve will move to Active Orders with CONFIRMED status</div>

      <form method="POST" action="/admin/orders/<%= order.id %>/approve" style="margin-top:10px;">
        <button class="btn" type="submit">✅ Approve</button>
      </form>

      <div style="height:10px"></div>

      <form method="POST" action="/admin/orders/<%= order.id %>/reject">
        <button class="btn danger" type="submit">❌ Reject</button>
      </form>
    </div>
  <% } %>

  <% if (os === "ACTIVE") { %>
    <div class="card">
      <h2>Actions (Active)</h2>

      <form method="POST" action="/admin/orders/<%= order.id %>/dispatch">
        <button class="btn secondary" type="submit">🚚 Mark Dispatched</button>
      </form>

      <div style="height:10px"></div>

      <form method="POST" action="/admin/orders/<%= order.id %>/mark-delivered">
        <button class="btn warn" type="submit">📦 Mark Delivered</button>
      </form>

      <div style="height:10px"></div>

      <form method="POST" action="/admin/orders/<%= order.id %>/close">
        <button class="btn" type="submit">🔒 Close Order</button>
      </form>
    </div>

    <div class="card">
      <h2>Payment</h2>
      <form method="POST" action="/admin/orders/<%= order.id %>/payment">
        <div class="row row-2">
          <div>
            <label>Status</label>
            <select name="payment_status">
              <option value="UNPAID" <%= pay==='UNPAID'?'selected':'' %>>UNPAID</option>
              <option value="PAID" <%= pay==='PAID'?'selected':'' %>>PAID</option>
            </select>
          </div>
          <div>
            <label>Method</label>
            <select name="payment_method">
              <option value="UPI">UPI</option>
              <option value="CASH">CASH</option>
              <option value="OTHER">OTHER</option>
            </select>
          </div>
        </div>

        <label style="margin-top:10px;">Note</label>
        <textarea name="payment_note" rows="2"><%= order.payment_note || "" %></textarea>

        <div style="height:10px"></div>
        <button class="btn secondary" type="submit">💾 Save Payment</button>
      </form>
    </div>
  <% } %>

</div>

<%- include("partials/footer", { active: "orders" }) %>
