<%- include("partials/header", { title: "Order Detail", subtitle: "Inferred vs Final", active: "orders" }) %>

<%
  const pay = order.payment_status || "UNPAID";
  const os = order.order_status || "QUEUE";
  const fs = order.fulfillment_status || "CONFIRMED";

  // inferred fallback (if not present use current)
  const iq = order.inferred_qty ?? order.qty;
  const ip = order.inferred_price_per_unit ?? order.price_per_unit;
  const isub = order.inferred_subtotal ?? order.subtotal;
  const idel = order.inferred_delivery_charge ?? order.delivery_charge;
  const itot = order.inferred_total ?? order.total;
  const iday = order.inferred_delivery_day ?? order.delivery_day;
  const iaddr = order.inferred_address_snapshot ?? order.address_snapshot;
%>

<% if (q && q.toast) { %>
  <div class="card" style="border-color: rgba(94,234,212,.35); background: rgba(94,234,212,.10);">
    ✅ <%= q.toast %>
  </div>
<% } %>

<div class="grid">

  <div class="card">
    <h2>Customer</h2>
    <div class="chips">
      <span class="chip ok"><%= order.customer_name || "Customer" %></span>
      <span class="chip"><%= order.phone %></span>
      <span class="chip <%= pay==='PAID' ? 'ok' : 'warn' %>">Payment: <%= pay %></span>
    </div>

    <div style="margin-top:10px; color:var(--muted); font-size:13px;">
      Bucket: <b style="color:var(--txt)"><%= os %></b>
      <% if (os === "ACTIVE") { %> • Status: <b style="color:var(--txt)"><%= fs %></b> <% } %>
    </div>
  </div>

  <% if (os === "QUEUE") { %>

    <div class="card">
      <h2>🔎 Inferred (read-only)</h2>
      <div class="chips">
        <span class="chip">Qty: <b><%= iq %> <%= order.unit_label %></b></span>
        <span class="chip">Day: <b><%= iday %></b></span>
        <span class="chip">₹/unit: <b><%= ip %></b></span>
      </div>

      <div style="margin-top:12px; display:grid; gap:6px;">
        <div>Subtotal: <b>₹<%= isub %></b></div>
        <div>Delivery: <b>₹<%= idel %></b></div>
        <div style="font-size:18px;">Total: <b>₹<%= itot %></b></div>
      </div>

      <div style="margin-top:10px; color:var(--muted); font-size:13px;">
        Address (inferred): <b style="color:var(--txt)"><%= iaddr %></b>
      </div>
    </div>

    <div class="card">
      <h2>✅ Final (editable)</h2>

      <form method="POST" action="/admin/orders/<%= order.id %>/final">
        <div class="row row-2">
          <div>
            <label>Final Qty</label>
            <input name="qty" value="<%= order.qty %>" />
          </div>

          <div>
            <label>Delivery Day</label>
            <select name="delivery_day">
              <option value="TODAY" <%= order.delivery_day==='TODAY'?'selected':'' %>>TODAY</option>
              <option value="TOMORROW" <%= order.delivery_day==='TOMORROW'?'selected':'' %>>TOMORROW</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row row-2">
          <div>
            <label>Price / Unit (optional override)</label>
            <input name="price_per_unit" value="<%= order.price_per_unit %>" />
          </div>
          <div>
            <label>Unit</label>
            <input value="<%= order.unit_label %>" disabled />
          </div>
        </div>

        <label style="margin-top:10px;">Final Address</label>
        <textarea name="address_snapshot" rows="3"><%= order.address_snapshot %></textarea>

        <div style="height:10px"></div>
        <button class="btn secondary" type="submit">💾 Save Final Values</button>
      </form>

      <div style="height:12px"></div>

      <form method="POST" action="/admin/orders/<%= order.id %>/approve">
        <button class="btn" type="submit">✅ Approve → Move to Active Orders (Confirmed)</button>
      </form>

      <div style="height:10px"></div>

      <form method="POST" action="/admin/orders/<%= order.id %>/reject">
        <button class="btn danger" type="submit">❌ Reject</button>
      </form>

    </div>

  <% } %>

  <% if (os === "ACTIVE") { %>

    <div class="card">
      <h2>Order Summary</h2>

      <div class="chips">
        <span class="chip ok">Status: <%= fs %></span>
        <span class="chip <%= pay==='PAID' ? 'ok' : 'warn' %>">Payment: <%= pay %></span>
      </div>

      <div style="margin-top:12px; display:grid; gap:8px;">
        <div>Qty: <b><%= order.qty %> <%= order.unit_label %></b></div>
        <div>Price/unit: <b>₹<%= order.price_per_unit %></b></div>
        <div>Subtotal: <b>₹<%= order.subtotal %></b></div>
        <div>Delivery: <b>₹<%= order.delivery_charge %></b></div>
        <div style="font-size:18px;">Total: <b>₹<%= order.total %></b></div>
      </div>

      <div style="margin-top:10px; color:var(--muted); font-size:13px;">
        Address: <b style="color:var(--txt)"><%= order.address_snapshot %></b>
      </div>
    </div>

    <div class="card">
      <h2>Actions (Active Orders)</h2>

      <form method="POST" action="/admin/orders/<%= order.id %>/dispatch">
        <button class="btn secondary" type="submit">🚚 Mark Dispatched</button>
      </form>

      <div style="height:10px"></div>

      <form method="POST" action="/admin/orders/<%= order.id %>/mark-delivered">
        <button class="btn warn" type="submit">📦 Mark Delivered</button>
      </form>

      <div style="height:10px"></div>

      <form method="POST" action="/admin/orders/<%= order.id %>/close">
        <button class="btn" type="submit">🔒 Close Order</button>
      </form>
    </div>

    <div class="card">
      <h2>Payment</h2>

      <form method="POST" action="/admin/orders/<%= order.id %>/payment">
        <div class="row row-2">
          <div>
            <label>Status</label>
            <select name="payment_status">
              <option value="UNPAID" <%= pay==='UNPAID'?'selected':'' %>>UNPAID</option>
              <option value="PAID" <%= pay==='PAID'?'selected':'' %>>PAID</option>
            </select>
          </div>
          <div>
            <label>Method</label>
            <select name="payment_method">
              <option value="UPI">UPI</option>
              <option value="CASH">CASH</option>
              <option value="OTHER">OTHER</option>
            </select>
          </div>
        </div>

        <label style="margin-top:10px;">Note</label>
        <textarea name="payment_note" rows="2"><%= order.payment_note || "" %></textarea>

        <div style="height:10px"></div>
        <button class="btn secondary" type="submit">💾 Save Payment</button>
      </form>
    </div>

  <% } %>

</div>

<%- include("partials/footer", { active: "orders" }) %>
