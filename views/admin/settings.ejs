<%- include("partials/header", { title: "Settings", subtitle: "Products • Delivery • Payment", active: "settings" }) %>

<% if (q && q.toast) { %>
  <div class="card" style="border-color: rgba(94,234,212,.35); background: rgba(94,234,212,.10);">
    ✅ <%= q.toast %>
  </div>
<% } %>

<div class="card">
  <h2>Settings Menu</h2>
<div style='margin:12px 0; display:flex; gap:10px; flex-wrap:wrap;'>
  <a href='/admin/settings?tab=main' style='padding:8px 12px; border-radius:10px; background:#111827; color:#fff; text-decoration:none;'>Main</a>
  
</div>

<div class="chips">
    <a class="chip <%= tab==='add' ? 'ok' : '' %>" href="/admin/settings?tab=add">Add Product</a>
    <a class="chip <%= tab==='manage' ? 'ok' : '' %>" href="/admin/settings?tab=manage">Manage Product</a>
    <a class="chip <%= tab==='delivery' ? 'ok' : '' %>" href="/admin/settings?tab=delivery">Delivery Master</a>
    <a class="chip <%= tab==='payment' ? 'ok' : '' %>" href="/admin/settings?tab=payment">Payment Master</a>
  </div>
</div>

<% if (tab === 'add') { %>

  <div class="card">
    <h2>➕ Add Product + Sub-Products</h2>
<div style='margin:12px 0; display:flex; gap:10px; flex-wrap:wrap;'>
  <a href='/admin/settings?tab=main' style='padding:8px 12px; border-radius:10px; background:#111827; color:#fff; text-decoration:none;'>Main</a>
  
</div>

<form method="POST" action="/admin/products/create-with-subs" id="addProductForm">
      <label>Product Name</label>
      <input name="product_name" placeholder="e.g. Mushrooms" />

      <div style="height:10px"></div>
      <h3 style="margin:0 0 8px;">Add Sub Products</h3>

      <div id="subsWrap" style="display:grid; gap:10px;">
        <div class="order" style="cursor:default; padding:12px;">
          <div class="row row-3">
            <div>
              <label>Sub-Product Name</label>
              <input name="sub_name" placeholder="e.g. Button Mushroom" />
            </div>
            <div>
              <label>Price</label>
              <input name="sub_price" placeholder="e.g. 200" />
            </div>
            <div>
              <label>Unit</label>
              <input name="sub_unit" value="KG" />
            </div>
          </div>
        </div>
      </div>

      <div style="height:10px"></div>

      <button class="btn secondary" type="button" onclick="addSubRow()">➕ Add Another Sub-Product</button>

      <div style="height:10px"></div>
      <button class="btn" type="submit">💾 Save Product & Sub-Products</button>
    </form>
  </div>

  <script>
    function addSubRow() {
      const wrap = document.getElementById("subsWrap");
      const row = document.createElement("div");
      row.className = "order";
      row.style.cursor = "default";
      row.style.padding = "12px";
      row.innerHTML = `
        <div class="row row-3">
          <div>
            <label>Sub-Product Name</label>
            <input name="sub_name" placeholder="e.g. Variant name" />
          </div>
          <div>
            <label>Price</label>
            <input name="sub_price" placeholder="e.g. 200" />
          </div>
          <div>
            <label>Unit</label>
            <input name="sub_unit" value="KG" />
          </div>
        </div>
        <div style="height:8px"></div>
        <button class="btn danger" type="button" onclick="this.parentElement.remove()">Remove</button>
      `;
      wrap.appendChild(row);
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }
  </script>

<% } %>

<% if (tab === 'manage') { %>

  <div class="card">
    <h2>📦 Manage Products</h2>
<div style='margin:12px 0; display:flex; gap:10px; flex-wrap:wrap;'>
  <a href='/admin/settings?tab=main' style='padding:8px 12px; border-radius:10px; background:#111827; color:#fff; text-decoration:none;'>Main</a>
  
</div>

<div class="chip">Tap a product to expand and edit</div>

    <% if (!products || products.length === 0) { %>
      <div style="margin-top:10px;" class="chip">No products yet. Go to Add Product.</div>
    <% } %>

    <div style="display:grid; gap:10px; margin-top:12px;">
      <% (products || []).forEach(p => { %>
        <details class="order" style="cursor:default; padding:12px;">
          <summary style="list-style:none; cursor:pointer; display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <strong style="font-size:16px;"><%= p.name %></strong>
              <small style="display:block; color:var(--muted);">Product ID: <%= p.id %></small>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="chip <%= p.is_active ? 'ok' : 'bad' %>"><%= p.is_active ? 'ACTIVE' : 'INACTIVE' %></span>
              <span class="chip">▼</span>
            </div>
          </summary>

          <div style="height:12px"></div>

          <div class="card" style="margin:0; padding:12px;">
            <h3 style="margin:0 0 8px;">Product Controls</h3>

            <form method="POST" action="/admin/products/<%= p.id %>/rename">
              <label>Rename Product</label>
              <div class="row row-2">
                <input name="name" value="<%= p.name %>" />
                <button class="btn secondary" type="submit">Save</button>
              </div>
            </form>

            <div style="height:10px"></div>

            <form method="POST" action="/admin/products/<%= p.id %>/toggle" style="margin:0;">
              <button class="btn <%= p.is_active ? 'danger' : 'secondary' %>" type="submit">
                <%= p.is_active ? 'Disable Product (auto disables all variants)' : 'Enable Product (auto enables all variants)' %>
              </button>
            </form>
          </div>

          <div style="height:12px"></div>

          <div class="card" style="margin:0; padding:12px;">
            <h3 style="margin:0 0 8px;">Sub-Products</h3>

            <% const list = (subsByProduct[p.id] || []); %>
            <% if (list.length === 0) { %>
              <div class="chip">No sub-products yet</div>
            <% } %>

            <div style="display:grid; gap:10px; margin-top:10px;">
              <% list.forEach(sp => { %>
                <div class="order" style="cursor:default; padding:12px;">
                  <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
                    <div>
                      <strong><%= sp.name %></strong>
                      <small style="display:block; color:var(--muted);">₹<%= sp.price_per_unit %> / <%= sp.unit_label %></small>
                    </div>
                    <span class="chip <%= sp.is_active ? 'ok' : 'bad' %>"><%= sp.is_active ? 'ACTIVE' : 'INACTIVE' %></span>
                  </div>

                  <form method="POST" action="/admin/sub-products" style="margin-top:10px;">
                    <input type="hidden" name="product_id" value="<%= p.id %>"/>
                    <input type="hidden" name="name" value="<%= sp.name %>"/>

                    <div class="row row-3">
                      <div>
                        <label>Price</label>
                        <input name="price_per_unit" value="<%= sp.price_per_unit %>" />
                      </div>
                      <div>
                        <label>Unit</label>
                        <input name="unit_label" value="<%= sp.unit_label %>" />
                      </div>
                      <div style="display:flex; align-items:flex-end;">
                        <button class="btn secondary" type="submit" style="width:100%;">Update</button>
                      </div>
                    </div>
                  </form>

                  <div style="height:8px"></div>

                  <form method="POST" action="/admin/sub-products/<%= sp.id %>/toggle" style="margin:0;">
                    <button class="btn <%= sp.is_active ? 'danger' : 'secondary' %>" type="submit">
                      <%= sp.is_active ? 'Disable Variant' : 'Enable Variant' %>
                    </button>
                  </form>
                </div>
              <% }) %>
            </div>

            <div style="height:12px"></div>

            <h3 style="margin:0 0 8px;">➕ Add New Sub-Product</h3>
            <form method="POST" action="/admin/sub-products">
              <input type="hidden" name="product_id" value="<%= p.id %>"/>
              <div class="row row-3">
                <div>
                  <label>Name</label>
                  <input name="name" placeholder="e.g. New Variant" />
                </div>
                <div>
                  <label>Price</label>
                  <input name="price_per_unit" placeholder="e.g. 250" />
                </div>
                <div>
                  <label>Unit</label>
                  <input name="unit_label" value="KG" />
                </div>
              </div>
              <div style="height:10px"></div>
              <button class="btn secondary" type="submit">Add Variant</button>
            </form>

          </div>

        </details>
      <% }) %>
    </div>

  </div>

<% } %>

<% if (tab === 'delivery') { %>
  <div class="card">
    <h2>🚚 Delivery Master</h2>
<div style='margin:12px 0; display:flex; gap:10px; flex-wrap:wrap;'>
  <a href='/admin/settings?tab=main' style='padding:8px 12px; border-radius:10px; background:#111827; color:#fff; text-decoration:none;'>Main</a>
  
</div>

<form method="POST" action="/admin/settings">
      <input type="hidden" name="product_name" value="<%= settings.product_name %>"/>
      <input type="hidden" name="today_price_per_unit" value="<%= settings.today_price_per_unit %>"/>
      <input type="hidden" name="unit_label" value="<%= settings.unit_label %>"/>
      <input type="hidden" name="upi_id" value="<%= settings.upi_id %>"/>

      <label>Free Delivery Above</label>
      <input name="free_delivery_threshold" value="<%= settings.free_delivery_threshold %>" />

      <label style="margin-top:10px;">Delivery Charge Amount</label>
      <input name="delivery_charge_amount" value="<%= settings.delivery_charge_amount %>" />

      <div style="height:10px"></div>
      <button class="btn" type="submit">Save Delivery Settings</button>
    </form>
  </div>
<% } %>

<% if (tab === 'payment') { %>
  <div class="card">
    <h2>💰 Payment Master</h2>
<div style='margin:12px 0; display:flex; gap:10px; flex-wrap:wrap;'>
  <a href='/admin/settings?tab=main' style='padding:8px 12px; border-radius:10px; background:#111827; color:#fff; text-decoration:none;'>Main</a>
  
</div>

<form method="POST" action="/admin/settings">
      <input type="hidden" name="product_name" value="<%= settings.product_name %>"/>
      <input type="hidden" name="today_price_per_unit" value="<%= settings.today_price_per_unit %>"/>
      <input type="hidden" name="unit_label" value="<%= settings.unit_label %>"/>
      <input type="hidden" name="free_delivery_threshold" value="<%= settings.free_delivery_threshold %>"/>
      <input type="hidden" name="delivery_charge_amount" value="<%= settings.delivery_charge_amount %>"/>

      <label>UPI ID</label>
      <input name="upi_id" value="<%= settings.upi_id %>" />

      <div style="height:10px"></div>
      <button class="btn" type="submit">Save Payment Settings</button>
    </form>
  </div>
<% } %>

<%- include("partials/footer", { active: "settings" }) %>





<!-- Language Tab -->








